clear
source globals
BASENAME=costsentry
LABEL=$BASENAME

DESC="This process will send a message to Pub/Sub simulating that a budget amount
has been exceeded. The following will happen:
    * A message will be sent through Pub/Sub that indicates a budget has been exceeded
        * The message uses example data that does not correspond to the actual budget
    * Cloud Functions will respond to thie event by shutting down labeled resources
        * This label was chosen when running the install script
    * Compute Engine instances will be 'stopped'
    * Cloud Run services will have 'allUsers' removed from access, rendering them private

Only resources that are configured with the label chosen when installing will be affected.    
"

print_title "COSTSENTRY SIMULATE OVERAGE " "$DESC" "1"

PROJECT=$(gcloud config get-value project | xargs)
handleProject PROJECT "$1"
printf "Using Project ID: $PROJECT \n\n"

collectParamters LABEL "$2" "the label chosen when installing Cost Sentry" "$LABEL"
computeRegionPicker REGION "$3" "run"


projectDetails "
Project ID:,$PROJECT
Region:,$REGION
"

section_open "Listing VMs to see status"
    gcloud compute instances list --filter="labels.$LABEL=true"
section_close

section_open "Listing Services to see status"
    gcloud run services list --filter="metadata.labels.$LABEL=true"
    printf "Below should have 'allUsers' in role 'run.invoker'\n"
    gcloud run services get-iam-policy costsentry-run-service --region $REGION --format="value(bindings)" 
section_close

section_open "Sending test billing overage message"
    MESSAGE=$(cat pubsub.test.json)
    gcloud pubsub topics publish $BASENAME-billing-channel --message="$MESSAGE"
    printf "Message sent to Pub/Sub: \n $MESSAGE \n"
    sleep 5
section_close

section_open "Listing VMs to see status"
    gcloud compute instances list --filter="labels.$LABEL=true"
section_close

section_open "Listing Services to see status"
    gcloud run services list --filter="metadata.labels.$LABEL=true"
    printf "Below should no longer have 'allUsers' have 'run.invoker'\n"
    gcloud run services get-iam-policy costsentry-run-service --region $REGION --format="value(bindings)" 
section_close