clear
source globals
BASENAME=costsentry
LABEL=$BASENAME

DESC="This process will send a simulated message saying your account is over 
budget to test the outcome. The following will happen:
    * You will generate a pubsub message that indicates a budget overage has happened
    * Cloud Functions will respond to thie event by shutting down tagged resources.
    * Compute Engine Instances will be 'stopped'
    * Cloud Run services will have 'allUsers' from access, rendering it private

It will only stop resources that are configured with a 'label' which you will select.    
"

print_title "COSTSENTRY SIMULATE OVERAGE " "$DESC" "1"

PROJECT=$(gcloud config get-value project | xargs)
handleProject PROJECT "$1"
collectParamters LABEL "$2" "the Compute Engine Instance label to which to apply cost sentry " "$LABEL"
computeRegionPicker REGION "$3" "run"


projectDetails "
Project ID:,$PROJECT
Region:,$REGION
"

section_open "Listing VMs to see status"
    gcloud compute instances list --filter="labels.$LABEL=true"
section_close

section_open "Listing Services to see status"
    gcloud run services list --filter="metadata.labels.$LABEL=true"
    printf "Below should have 'allUsers' in role 'run.invoker'\n"
    gcloud run services get-iam-policy costsentry-run-service --region $REGION --format="value(bindings)" 
section_close

section_open "Sending test billing overage message"
    MESSAGE=$(cat pubsub.test.json)
    gcloud pubsub topics publish $BASENAME-billing-channel --message="$MESSAGE"
    sleep 5
section_close

section_open "Listing VMs to see status"
    gcloud compute instances list --filter="labels.$LABEL=true"
section_close

section_open "Listing Services to see status"
    gcloud run services list --filter="metadata.labels.$LABEL=true"
    printf "Below should no longer have 'allUsers' have 'run.invoker'\n"
    gcloud run services get-iam-policy costsentry-run-service --region $REGION --format="value(bindings)" 
section_close