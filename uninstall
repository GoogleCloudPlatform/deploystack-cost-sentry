clear
source globals
OUTPUTFILE="uninstall.sh"
BASENAME=costsentry



DESC="This process will delete the following:
    * Billing Budget created by costsentry
    * Compute Engine Instance  created by costsentry
    * Cloud Run Service  created by costsentry
    * Cloud Function created by costsentry

Only resources created by Cost Sentry will be affected.    
"

print_title "COSTSENTRY UNINSTALL" "$DESC" "3"


handleProject PROJECT "$1"
determineBillingAccount BA

computeRegionPicker REGION "$2" "run"
computeZonePicker ZONE "$3" "$REGION"

SAFUNCTIONSUSER=$BASENAME-functions-sa
SAFUNCTIONS=$SAFUNCTIONSUSER@$PROJECT.iam.gserviceaccount.com

projectDetails "
Project ID:,$PROJECT
Region:,$REGION
Zone:,$ZONE
Billing Account:,$BA
Budget Ammount:,$BUDGETAMOUNT
Project Number:,$PROJECTNUMBER
Compute Service Account:,$SACOMPUTE
Functions Service Account:,$SAFUNCTIONS
"

section_open "Deleting the Cloud Function"
    prGcloud "gcloud functions delete costsentry -q"
section_close

section_open "Deleting the service account"
    prGcloud "gcloud iam service-accounts delete $SAFUNCTIONS -q" 
section_close

section_open "Deleting the Budget"
    BUDGETNAME=$(gcloud beta billing budgets list --format="value(NAME)" --billing-account $BA --filter="displayName:$BASENAME-budget" | xargs)
    prGcloud "gcloud beta billing budgets delete $BUDGETNAME -q"
section_close


section_open "Delete Compute Instance to enforce"
    prGcloud "gcloud compute instances delete $BASENAME-example --zone $ZONE -q"
 section_close

 section_open "Delete Cloud Run Service to enforce"
    prGcloud "gcloud run services delete $BASENAME-run-service --region=$REGION -q"   
 section_close

 

section_open "Delete Pub/Sub channel"
    prGcloud "gcloud pubsub topics delete $BASENAME-billing-channel -q" 
section_close 