clear
source globals
BASENAME=costsentry
ZONE=us-central1-a
PROJECT=$(gcloud config get-value project | xargs)
BA=$(gcloud beta billing accounts list --format="value(ACCOUNT_ID)" | xargs)

print_title "COSTSENTRY UNINSTALL" "This process will delete a Billing Budget, some VMs and a process that will stop the VM when the \nbudget is exceeeded." "5"

collectParamters PROJECT "$1" "the id of the Google Cloud Project" "$PROJECT"
collectParamters ZONE "$2" "the Google Cloud Zone" "$ZONE" 


SAFUNCTIONSUSER=$BASENAME-functions-sa
SAFUNCTIONS=$SAFUNCTIONSUSER@$PROJECT.iam.gserviceaccount.com


section_open "Deleting the Cloud Function"
    gcloud functions delete costsentry -q
section_close

section_open "Deleting the service account"
    gcloud iam service-accounts delete $SAFUNCTIONS -q 
section_close


section_open "Deleting the Budget"
    BUDGETNAME=$(gcloud beta billing budgets list --format="value(NAME)" --billing-account $BA --filter="displayName:$BASENAME-budget" | xargs)
    gcloud beta billing budgets delete $BUDGETNAME -q
section_close




section_open "Delete Compute Instance to enforce"
    gcloud compute instances delete $BASENAME-example --zone $ZONE -q
 section_close

section_open "Delete Pub/Sub channel"
    gcloud pubsub topics delete $BASENAME-billing-channel -q 
section_close 